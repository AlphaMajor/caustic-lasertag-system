---
layout: documentation
title: Как собрать и прошить
show-on-header: false
is-documentation: true
---

## Как собрать прошивку и загрузчик
На данный момент поддерживается сборка только из-под Linux, однако проект использует `CMake`, так что добавить поддержку Windows не составит труда.

У вас дожен быть установлен `cmake`, компилятор `arm-none-eabi-gcc`, **включая** `arm-none-eabi-newlib` и `arm-none-eabi-binutils`. Компилятор должен быть доступен в `$PATH`. Обычно, достаточно просто установить соответствующие пакеты из репозитория вашего дистрибутива. Для прошивки нужен программатор ST-link и соответствующая утилита `stlink`. 

Загрузчик **не является** обязательным.

Итак, для установки:

  - Склонируйте этот репозиторий:
    
    `git clone https://github.com/DAlexis/caustic-lasertag-system.git`
  - Перейдите в папку `cpp-sources`:
    
    `cd caustic-lasertag-system/cpp-sources`
  - Инициализируйте и загрузите подмодуль, содержащий загрузчик:
    
    `git submodule init && git submodule update`
  - Запустите `build.sh` для сборки в режиме build, или `build.sh release` для сборки в release

Теперь, чтобы запрограммировать устройство:
  - Подключите программатор к плате устройства и к компьютеру. Включите питание устройства
  - Чтобы прошить основную программу, наберите
  
    `flash-universal-device.sh`
  - Чтобы прошить загрузчик:
  
    `flash-bootloader.sh`
    Чтобы прошить программу, собранную в release, добавьте параметр `release` к каждому из скриптов.

    **ВАЖНО:** При прошивке загрузчика стирается всё, что до этого было зашито в контроллер. Поэтому после прошивки загрузчика нужно сделать следующее: переименовать `universal-device.bin` в `flash.bin` и положить в корень sd-карты (это можно сделать, просто подключив устройство по USB к компьютеру). После перезагрузки устройства загрузчик автоматически зальет прошивку в контроллер. Вообще говоря, можно вообще не использовать загрузчик.

  - Скопируйте необходимое содержимое на sd-карту. Например, если устройство --- это оружие игрока, скопируйте всё содержимое `sdcards/rifle` на карту устройства. Именно так прошивка поймёт, "кем быть".
