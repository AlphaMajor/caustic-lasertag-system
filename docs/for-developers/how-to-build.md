---
layout: documentation
title: Как собрать и прошить
show-on-header: false
is-documentation: true
---

## Как собрать прошивку и загрузчик
На данный момент поддерживается сборка только из-под Linux, однако проект использует `CMake`, так что добавить поддержку Windows не составит труда.

Чуть позднее в репозиторий будет добавлена готовая к использованию бинарная
прошивка.

В проекте Caustic присутствует две прошивки: сама лазертаг-система, и загрузчик.
Закрузчик не является обязательным компонентом, однако он упрощает
перепрошивку оборудования у конечного пользователя. Загрузчик позволяет при подключении устройства 
по USB к компьютеру работать с картой памяти устройства, как с обычной флешкой.
Чтобы обновить прошивку системы при установленном загрузчике, достаточно
просто скопировать её в корень sd-карты. Загрузчик прошивается программатором
однократно.

Можно обойтись без загрузчика и прошивать систему на при помощи программатора.
Такой подход удобен при отладке, поскольку такая операция выполняется 
быстрее и не требует переподключать устройство к компьютеру.

Для обычных пользователя рекомендуется установить загрузчик.

### Установка необходимых пакетов

У вас дожен быть установлен `cmake`, компилятор `arm-none-eabi-gcc`, 
и необходимые компоненты: `arm-none-eabi-newlib` и `arm-none-eabi-binutils`.
Путь к компилятору должен быть указан в `$PATH`. Обычно, достаточно просто установить
соответствующие пакеты из репозитория вашего дистрибутива.

Для прошивки нужен программатор ST-link и соответствующая утилита `stlink`. 

### Ubuntu и производные

Вам понадобится `git` и `cmake`, если, конечно, их ещё нет в вашей системе:

`$ sudo apt install git cmake`

Для компиляции под STM32 нужно установить:

`$ sudo apt install gcc-arm-none-eabi gdb-arm-none-eabi binutils-arm-none-eabi libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib`

Программу для работы с программатором ST-link придется установить из её репозитория:

`$ sudo apt install libusb-1.0-0-dev g++`

`$ git clone https://github.com/texane/stlink.git`

`$ cd stlink`

`$ make`

`$ cd build/Release`

`$ sudo make install`

`$ LD_LIBRARY_PATH=/usr/local/lib`

`$ sudo ldconfig`

Теперь вам доступна утилита `st-flash`, и всё должно собираться.

### Archlinux

Аналогично `git` и `cmake`:

`$ sudo pacman -S git cmake`

А также компилятор со всем необходимым:

`$ sudo pacman -S arm-none-eabi-binutils arm-none-eabi-gcc arm-none-eabi-gdb arm-none-eabi-newlib`

Программа для работы с ST-LINK есть в репозитории:

`$ sudo pacman -S stlink`


### Сборка

Теперь, чтобы собрать проект:

  - Склонируйте репозиторий проекта:
    
    `git clone https://github.com/DAlexis/caustic-lasertag-system.git`
    
  - Инициализируйте и загрузите подмодуль, содержащий загрузчик:
    
    `git submodule init && git submodule update`
    
  - Перейдите в папку `cpp-sources`:
    
    `cd caustic-lasertag-system/cpp-sources`
    
  - Запустите `build.sh` для сборки в режиме build, или `build.sh release` для сборки в release

Чтобы запрограммировать устройство с загрузчиком:

  - Подключите программатор к плате устройства и к компьютеру. Включите питание устройства.
  
  - Перейдите в папку `cpp-source` и запустите скрипт `./flash-bootloader.sh` или `./flash-bootloader.sh release` для прошивки релизной
    сборкой. После этого установится загрузчик.
  
  - Отключите питание устройства, отключите от него программатор. 
    Карта памяти должна быть отформатирована в FAT32 и установлена
    в устройство.
    Подсоедините устройство USB-кабелем к компьютеру, а затем включите. Если
    все прошло правильно, система опознает девайс, как флешку.
    
  - Из папки `cpp-sources/build/debug/universal-device` скопируйте на <<флешку>>
    файл `universal-device.bin` и переименуйте его в `flash.bin`.
    
  - Перезагрузите устрйоство и подождите 1 минуту. Этого достаточно, чтобы
    загрузчик записал прошивку.

Чтобы запрограммировать устройство без загрузчика:

  - Подключите программатор к плате устройства и к компьютеру. Включите питание устройства.
  
  - Перейдите в папку `cpp-source` и запустите скрипт `./flash-universal-device.sh` или `./flash-universal-device.sh release` для прошивки релизной
    сборкой.
    
Далее, необходимо скопировать на устройство необходимые файлы. Например,
если устройство --- это оружие игрока, скопируйте всё содержимое `sdcards/rifle`
на карту устройства. Именно так прошивка поймёт, <<кем быть>>.
В случае головной повязки скопируйте всё из `sdcards/head-sensor`.
Не забудьте настроить адрес повязки и оружия в файле `config.ini`.
