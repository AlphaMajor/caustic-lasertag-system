---
layout: documentation
title: Протокол RCSP
show-on-header: false
is-documentation: true
---

## Протокол RCSP
RCSP (Remote Control and Synchronization Protocol) --- бинарный протокол
управления и синхронизации переменных устройств системы Caustic. Он
представляет собой универсальный API, позволяющий реализовать практически
любой мыслимый функционал.

### Использование в системе
RCSP является протоколом уровня представления и используется в системе
для передачи команд по разным каналам:

 - Через радиосвязь -- удаленное управление игрой, настройка оборудования,
 получение статистики, связь повязка-оружие и т.п.
 
 - Через ИК-канал -- команды ИК-протокола транслируются в команды RCSP и
 обратно. Однако RCSP-сообщение может быть передано непосредственно по
 ИК-каналу в случае, если используемый ИК-протокол не поддерживает нужного
 функционала
 
 - Запись и чтение из файлов на SD-карте. Настройки и состояние системы 
 сохраняется в виде RCSP-сообщений в файлах
 
 - Через RFID метки. Любая команда может быть записана на RFID-карте и
 использоваться в игре

![Логика системы]({{ '/graphviz/rcsp.gv.png' | prepend: site.baseurl }}){:class="img-responsive"}
 
### RCSP-сообщения
Единицей обмена данными через RCSP является сообщение. Сообщения могут
быть объединены в единый бинарный поток. Такой поток не требует дополнительной
метаинформации. Сообщение имеет следующую структуру, последовательно:

| 1 byte | 2 bytes | arg_size bytes |
|:-:|:-:|:-:|
| uint8_t arg_size | uint16_t op_code |  argument |

 - `arg_size` --- размер аргумента операции, принимает значения [0..255]
 - `op_code` --- код операции
 - `argument` --- аргумент операции. Отсутствует, если `arg_size == 0`

Таким образом, `arg_size` и `op_code` составляют заголовок сообщения. 
Поскольку размер сообщения всегда составляет `arg_size + 3` байт, сообщения
с неизвестным кодом операции могут быть пропущены без ущерба для остальных
сообщений, входящих в поток.

Тип операции задается двумя старшими битами `op_code`. Поддерживается 
3 типа операций:

| Тип |  Битовая маска  | Операция |
|:---:|:---------------:|:---------|
|Set parameter (SP)     | 01xxxxxxxxxxxxxx| Установить значение некоторой переменной в `argument` |
|Request parameter (RP) | 10xxxxxxxxxxxxxx| Запросить значение переменной |
|Call request (CR)      | 00xxxxxxxxxxxxxx| Вызвать функцию с параметром `argument` |

Запросы Request parameter (RP) применяются только в ситуации, когда канал
связи, использующий протокол RCSP, двухсторонний. На данный момент это
справедливо только для радиоканала. RP-запрос подразумевает формирование
ответного сообщения, состоящего, в свою очередь, исключительно из 
SP-сообщений. Например:

 - Головная повязка имеет зарегистрированный в RCSP-системе 
 параметр healthCurrent. Оружие имеет такой же параметр для того, чтобы
 отображать его на дисплее. Но для этого требуется синхронизация.
 
 - Оружие посылает RP-запрос на головную повязку, для парамера healthCurrent.
 В ответ повязка формирует SP-сообщение со значением healthCurrent.
 
 - Когда оружие принимает SP-сообщение для параметра healthCurrent, значение
 одноименной переменной изменяется автоматически. Таким образом код, который
 отвечает за вывод текста на экран, выведет при следующем обновлении уже
 измененное значение.
